version: 1
type: pipeline-template
templateType: MULTIBRANCH
name: Multibranch - GitHub - Kaniko - Maven - Docker
description: CI pipeline multibranch to model Maven Docker Apps projects using a Kaniko agent Filter. GitHub SCM.
parameters:
- name: k8_agent_yaml
  displayName: Kubernetes Agent yaml
  allowedValues: [maven_kaniko_pod_cache, maven_kaniko_pod]
  type: string
- name: gh_cred
  displayName: GitHub Credential
  type: credentials
- name: gh_owner
  displayName: GitHub Owner Name
  type: string  
- name: gh_repo
  displayName: GitHub Repository Name
  type: string
- name: gh_watched_branches
  type: string
  displayName: Watched Branch selection pattern (Space-separated list)
  defaultValue: master develop
- name: d_path
  type: string
  displayName: Dockerfile build path
- name: d_latest
  type: boolean
  displayName: Tag as latest?
  defaultValue: false
- name: d_registry
  type: string
  displayName: Docker Registry
  defaultValue: supportbeescloud
multibranch:
  branchSource:
    github:
      repoOwner: ${gh_owner}
      repository: ${gh_repo}
      credentialsId: ${gh_cred}
      traits:
      - headWildcardFilter:
          includes: ${gh_watched_branches}
      - gitHubBranchDiscovery:
          strategyId: '1'
      - gitHubPullRequestDiscovery:
          strategyId: '1'
      - gitHubTagDiscovery
    strategy:
      $class: DefaultBranchPropertyStrategy # All branches get the same properties
      props:
      - $class: NoTriggerBranchProperty   # Suppress automatic SCM triggering
  #Check Markerfile Options: https://docs.cloudbees.com/docs/cloudbees-ci/latest/pipeline-templates-user-guide/managing-multibranch-pipeline-options#_examples
  markerFile: pom.xml  
  scanRepositoryInterval: 2 hours
